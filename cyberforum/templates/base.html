{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å –£–¥–º—É—Ä—Ç–∏–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'core:home' %}">–§–∏–Ω–ì—Ä–∞–º–æ—Ç–∞ –£–¥–º—É—Ä—Ç–∏–∏</a>
            <div class="navbar-nav ms-auto">
        <a class="nav-link" href="{% url 'core:home' %}">–ì–ª–∞–≤–Ω–∞—è</a>
        <a class="nav-link" href="{% url 'courses:list' %}">–ö—É—Ä—Å—ã</a>
        <a class="nav-link" href="{% url 'core:contacts' %}">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
        <a class="nav-link" href="{% url 'core:events' %}">–°–æ–±—ã—Ç–∏—è</a>
        {% if user.is_authenticated %}
            <a class="nav-link" href="{% url 'core:profile' %}">–ö–∞–±–∏–Ω–µ—Ç</a>
            <a class="nav-link" href="{% url 'core:logout' %}">–í—ã–π—Ç–∏</a>
        {% else %}
            <a class="nav-link" href="{% url 'core:login' %}">–í–æ–π—Ç–∏</a>
            <a class="nav-link" href="{% url 'core:register' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        {% endif %}
        <form class="d-flex ms-3" action="{% url 'search:results' %}" method="get">
            <input class="form-control me-2" type="search" name="q" placeholder="–ü–æ–∏—Å–∫..." aria-label="–ü–æ–∏—Å–∫">
            <button class="btn btn-outline-light" type="submit">–ù–∞–π—Ç–∏</button>
        </form>
    </div>
        </div>
    </nav>


    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <div id="chatbot-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; width: 320px; height: 450px; display: flex; flex-direction: column; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 16px; background-color: white; overflow: hidden;">

    <div style="background-color: #d4c8b7; color: #5a6b4d; padding: 12px; font-weight: bold; display: flex; align-items: center; justify-content: space-between;">
        üí∞üíº –ì–µ–Ω–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤
        <button onclick="toggleChat()" style="background: none; border: none; color: #333; cursor: pointer; font-size: 16px;">√ó</button>
    </div>

    <div id="chat-messages" style="flex-grow: 1; padding: 12px; overflow-y: auto; background-color: #f8f6f0; max-height: 320px;"></div>

    <div style="display: flex; padding: 10px; border-top: 1px solid #e0e0e0;">
        <input type="text" id="chat-input" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å"
               style="flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 20px; outline: none;"
               onkeydown="if(event.key==='Enter') sendQuestion()">
        <button onclick="sendQuestion()"
                style="margin-left: 8px; padding: 8px 16px; background-color: #6a7d5d; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px;">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
    </div>
</div>

<div id="chat-open-btn" style="position: fixed; bottom: 20px; right: 20px; z-index: 9998; width: 50px; height: 50px; border-radius: 50%; background-color: #6a7d5d; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; display: none;">üí¨</div>

<script>
    function toggleChat() {
    const widget = document.getElementById('chatbot-widget');
    const openBtn = document.getElementById('chat-open-btn');

    if (widget.style.display === 'none' || !widget.style.display) {
        widget.style.display = 'flex';
        openBtn.style.display = 'none';
        // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
        sendGreeting();
    } else {
        widget.style.display = 'none';
        openBtn.style.display = 'flex';
    }
}

    // ‚úÖ –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –±—ã–ª–æ –ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    let greetingSent = false;

// ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
    function sendGreeting() {
        if (greetingSent) return; // –£–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Äî –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º

        const messageArea = document.getElementById('chat-messages');

        const greeting = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø ‚Äî –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü–æ–º–æ—â–Ω–∏–∫. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî –ø–æ–º–æ–≥—É!";

        appendMessage(greeting, 'bot');

        greetingSent = true; // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
}

    window.onload = function() {
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî —á–∞—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é? –ù–µ—Ç ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
        document.getElementById('chatbot-widget').style.display = 'none';
        document.getElementById('chat-open-btn').style.display = 'flex';
    };

    async function sendQuestion() {
        const input = document.getElementById('chat-input');
        const messageArea = document.getElementById('chat-messages');
        const question = input.value.trim();

        if (!question) return;

        appendMessage(question, 'user');
        input.value = '';

        appendMessage("üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...", 'bot');

        try {
            const response = await fetch('/chat-ask/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ question: question })
            });

            const data = await response.json();

            const lastMsg = messageArea.lastElementChild;
            if (lastMsg && lastMsg.classList.contains('bot')) {
                messageArea.removeChild(lastMsg);
            }

            if (data.error) {
                appendMessage(`‚ùå ${data.error}`, 'bot');
            } else {
                appendMessage(data.answer, 'bot');
            }

        } catch (error) {
            const lastMsg = messageArea.lastElementChild;
            if (lastMsg && lastMsg.classList.contains('bot')) {
                messageArea.removeChild(lastMsg);
            }
            appendMessage("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.", 'bot');
        }
    }

    function appendMessage(text, sender) {
        const messageArea = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');
        msgDiv.style.marginBottom = '12px';
        msgDiv.style.maxWidth = '80%';
        msgDiv.style.padding = '10px 14px';
        msgDiv.style.borderRadius = sender === 'user' ? '18px 18px 0 18px' : '18px 18px 18px 0';
        msgDiv.style.backgroundColor = sender === 'user' ? '#6a7d5d' : '#f0f0f0';
        msgDiv.style.color = sender === 'user' ? 'white' : '#333';
        msgDiv.style.wordWrap = 'break-word';
        msgDiv.style.fontSize = '14px';
        msgDiv.style.alignSelf = sender === 'user' ? 'flex-end' : 'flex-start';
        msgDiv.textContent = text;
        msgDiv.className = sender;
        messageArea.appendChild(msgDiv);
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('chat-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') sendQuestion();
    });

    // –§–∏–∫—Å: –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á–∞—Ç –∑–∞–∫—Ä—ã—Ç
    function updateChatButtonVisibility() {
        const widget = document.getElementById('chatbot-widget');
        const openBtn = document.getElementById('chat-open-btn');

        if (widget.style.display === 'none' || !widget.style.display) {
            openBtn.style.display = 'flex';
        } else {
            openBtn.style.display = 'none';
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–∫—Ä–æ–ª–ª–µ –∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('scroll', updateChatButtonVisibility);
    window.addEventListener('load', updateChatButtonVisibility);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä—ã—Ç–∏—è
    document.getElementById('chat-open-btn').addEventListener('click', function() {
        toggleChat();
        // –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        updateChatButtonVisibility();
    });

    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
    window.addEventListener('resize', updateChatButtonVisibility);

</script>
<style>
    #chatbot-widget {
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateX(300px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>


    <footer class="bg-light text-center py-3 mt-5">
        <p class="mb-0">¬© 2025 –ü–æ—Ä—Ç–∞–ª —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –£–¥–º—É—Ä—Ç–∏–∏</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>