<!-- templates/core/calendar.html -->
{% extends 'base.html' %}
{% load static %}

{% block head %}
  <link href="{% static 'css/events.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<style>
  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ ‚Äî –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ */


</style>

<h1 class="mb-4">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h1>
<div id="calendar" style="height: 600px; overflow:auto;"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal fade" id="dayEventsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDateTitle">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ ...</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body" id="modalEventsList"></div>
      <div class="modal-footer" id="modalFooter">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar -->
<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales/ru.global.min.js"></script>
<script>
 document.addEventListener('DOMContentLoaded', function () {
    if (typeof FullCalendar === 'undefined') {
        document.getElementById('calendar').innerHTML = `<div class="alert alert-danger">‚ùå FullCalendar –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.</div>`;
        return;
    }

    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ru',
        initialView: 'dayGridMonth',
        // –ï–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
        },
        // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∞–¥–∞–ø—Ç–∞—Ü–∏—é –ø–∞–Ω–µ–ª–∏ (—á—Ç–æ–±—ã –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–∏—Å—å –∫–Ω–æ–ø–∫–∏)
        stickyHeaderDates: false,
        // –°–æ–±—ã—Ç–∏—è
        events: '{% url "events:events_api" %}',
        dateClick: function (info) {
            fetchEventsForDate(info.dateStr);
        }
    });

    calendar.render();

    function fetchEventsForDate(dateStr) {
        fetch('{% url "events:events_api" %}')
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(events => {
                const dayEvents = events.filter(e => e.start === dateStr);
                showDayEventsModal(dateStr, dayEvents);
            })
            .catch(() => {
                document.getElementById('modalEventsList').innerHTML = '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.</p>';
                new bootstrap.Modal(document.getElementById('dayEventsModal')).show();
            });
    }

    function showDayEventsModal(dateStr, events) {
        const titleEl = document.getElementById('modalDateTitle');
        const bodyEl = document.getElementById('modalEventsList');
        const footerEl = document.getElementById('modalFooter');

        const date = new Date(dateStr);
        const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        titleEl.textContent = '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ ' + date.toLocaleDateString('ru-RU', opts);

        let html = '';
        if (events.length === 0) {
            html = '<p>–ù–∞ —ç—Ç—É –¥–∞—Ç—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ.</p>';
            footerEl.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>';
        } else {
            html = '<ul class="list-group list-group-flush">';
            events.forEach(e => {
                html += `
                    <li class="list-group-item">
                        <strong>${e.title}</strong><br>
                        üìç ${e.extendedProps.location}<br>
                        üë• –ê—É–¥–∏—Ç–æ—Ä–∏—è: ${e.extendedProps.audience}<br>
                        ${e.extendedProps.description}
                    </li>`;
            });
            html += '</ul>';

            footerEl.innerHTML = `
                <a href="/events/?date_from=${encodeURIComponent(dateStr)}&date_to=${encodeURIComponent(dateStr)}" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            `;
        }

        bodyEl.innerHTML = html;
        new bootstrap.Modal(document.getElementById('dayEventsModal')).show();
    }
});
</script>
{% endblock %}